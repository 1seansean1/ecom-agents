<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat UI</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Left Sidebar: Parameters -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <h2>Parameters</h2>
                <button id="sidebar-toggle" title="Toggle sidebar">&laquo;</button>
            </div>

            <div class="sidebar-content">
                <!-- Provider & Model -->
                <div class="param-group">
                    <label>Provider</label>
                    <select id="provider-select"></select>
                </div>
                <div class="param-group">
                    <label>Model</label>
                    <select id="model-select"></select>
                </div>

                <!-- System Prompt -->
                <div class="param-group">
                    <label>System Prompt</label>
                    <textarea id="system-prompt" rows="3" placeholder="You are a helpful assistant..."></textarea>
                </div>

                <!-- Dynamic Parameters -->
                <div id="params-container"></div>

                <!-- Presets -->
                <div class="param-group">
                    <label>Presets</label>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="creative">Creative</button>
                        <button class="preset-btn" data-preset="precise">Precise</button>
                        <button class="preset-btn" data-preset="balanced">Balanced</button>
                        <button class="preset-btn" data-preset="deterministic">Deterministic</button>
                    </div>
                </div>

                <!-- SMS Section -->
                <div class="param-group sms-section">
                    <label>SMS Forward</label>
                    <div class="sms-row">
                        <input type="tel" id="sms-phone" placeholder="Phone number" />
                        <select id="sms-carrier"></select>
                    </div>
                    <button id="sms-send" class="sms-btn" disabled>Send Last Response via SMS</button>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main id="chat-area">
            <div id="chat-header">
                <button id="sidebar-open" class="hidden" title="Open sidebar">&#9776;</button>
                <div id="header-info">
                    <span id="active-provider">OpenAI</span>
                    <span class="sep">/</span>
                    <span id="active-model">gpt-4o</span>
                </div>
                <div id="context-meter">
                    <div id="context-bar-wrap" title="Context window usage">
                        <div id="context-bar-fill"></div>
                    </div>
                    <span id="context-label">0 / 128K</span>
                    <button id="context-panel-toggle" title="Toggle context panel">CTX</button>
                </div>
                <div id="header-actions">
                    <button id="code-toggle" title="Code Mode: AI coding assistant with file access">Code</button>
                    <button id="socratic-toggle" title="Socratic Mode: multi-model roundtable debate">Socratic</button>
                    <button id="new-chat" title="New chat">+ New Chat</button>
                    <button id="export-chat" title="Export chat">Export</button>
                    <button id="help-toggle" title="Documentation &amp; Help">?</button>
                </div>
            </div>

            <!-- Context Panel (slides down) -->
            <div id="context-panel" class="hidden">
                <div id="context-panel-header">
                    <span>Shared Memory Context</span>
                    <span id="context-total"></span>
                </div>
                <div id="context-panel-body"></div>
            </div>

            <!-- Socratic Config Panel -->
            <div id="socratic-panel" class="hidden">
                <div id="socratic-panel-header">
                    <span>Socratic Roundtable</span>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <label style="font-size:10px;color:var(--text-muted);text-transform:none;letter-spacing:0;">Rounds:</label>
                        <select id="socratic-rounds" style="width:48px;padding:2px 4px;font-size:11px;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                        <button id="socratic-reset" title="Reset to defaults" style="font-size:10px;padding:2px 6px;">Reset</button>
                    </div>
                </div>
                <div id="socratic-participants"></div>
            </div>

            <!-- Code Mode Config Panel -->
            <div id="code-panel" class="hidden">
                <div id="code-panel-header">
                    <span>Code Mode</span>
                    <span id="code-turn-counter"></span>
                </div>
                <div id="code-panel-body">
                    <div class="code-config-row" style="flex:2;min-width:260px;">
                        <label>Working Directory</label>
                        <input type="text" id="code-working-dir" value="c:\Users\seanp\Workspace" placeholder="C:\path\to\project" />
                    </div>
                    <div class="code-config-row">
                        <label>Model</label>
                        <select id="code-model-select">
                            <option value="claude-opus-4-6">Claude Opus 4.6</option>
                            <option value="claude-sonnet-4-5-20250929" selected>Claude Sonnet 4.5</option>
                            <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5</option>
                        </select>
                    </div>
                    <div class="code-config-row">
                        <label>Max Turns</label>
                        <input type="number" id="code-max-turns" value="25" min="1" max="50" style="width:60px;" />
                    </div>
                    <div class="code-config-row" style="flex:2;min-width:260px;">
                        <label>Allowed Tools</label>
                        <div id="code-tools-checkboxes" class="code-tools-grid">
                            <label><input type="checkbox" value="bash_exec" checked /> bash_exec</label>
                            <label><input type="checkbox" value="read_file" checked /> read_file</label>
                            <label><input type="checkbox" value="write_file" checked /> write_file</label>
                            <label><input type="checkbox" value="edit_file" checked /> edit_file</label>
                            <label><input type="checkbox" value="list_files" checked /> list_files</label>
                            <label><input type="checkbox" value="search_files" checked /> search_files</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="messages"></div>

            <div id="input-area">
                <div id="input-wrapper">
                    <textarea id="user-input" placeholder="Type your message... (Shift+Enter for newline)" rows="1"></textarea>
                    <button id="send-btn" title="Send">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </button>
                    <button id="stop-btn" class="hidden" title="Stop generation">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="6" y="6" width="12" height="12" rx="2"/>
                        </svg>
                    </button>
                </div>
                <div id="input-footer">
                    <span id="token-estimate"></span>
                </div>
            </div>
        </main>

        <!-- Help / Docs Overlay -->
        <div id="help-overlay" class="hidden">
            <div id="help-modal">
                <div id="help-header">
                    <h2>Documentation</h2>
                    <button id="help-close">&times;</button>
                </div>
                <div id="help-nav">
                    <button class="help-tab active" data-tab="overview">Overview</button>
                    <button class="help-tab" data-tab="chat">Chat</button>
                    <button class="help-tab" data-tab="socratic">Socratic</button>
                    <button class="help-tab" data-tab="code">Code Mode</button>
                    <button class="help-tab" data-tab="params">Parameters</button>
                    <button class="help-tab" data-tab="shortcuts">Shortcuts</button>
                </div>
                <div id="help-body">
                    <!-- Overview -->
                    <div class="help-section" data-tab="overview">
                        <h3>Chat UI</h3>
                        <p>A multi-provider AI chat interface with advanced features for power users.</p>

                        <h4>Providers</h4>
                        <ul>
                            <li><strong>OpenAI</strong> &mdash; GPT-4o, GPT-4o Mini, o1-mini, o3-mini</li>
                            <li><strong>Anthropic</strong> &mdash; Claude Opus 4.6, Sonnet 4.5, Haiku 4.5</li>
                            <li><strong>Google</strong> &mdash; Gemini 2.0 Flash, 2.5 Pro</li>
                            <li><strong>Grok</strong> &mdash; Grok 2, Grok 3</li>
                        </ul>
                        <p>Switch providers and models mid-conversation &mdash; the full context carries over. A divider shows when the responding model changes.</p>

                        <h4>Layout</h4>
                        <ul>
                            <li><strong>Left sidebar</strong> &mdash; Provider, model, system prompt, parameters, presets, SMS forward</li>
                            <li><strong>Center</strong> &mdash; Chat messages, mode toggles, context meter</li>
                            <li><strong>Right sidebar</strong> &mdash; Conversation history (persisted in localStorage)</li>
                        </ul>

                        <h4>API Keys</h4>
                        <p>Set your keys in the <code>.env</code> file in the chat-ui directory:</p>
                        <pre>OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GOOGLE_API_KEY=AI...
XAI_API_KEY=xai-...</pre>
                        <p>Keys are validated on page load. Invalid providers show <span style="color:var(--danger)">(no key)</span> in dropdowns.</p>
                    </div>

                    <!-- Chat -->
                    <div class="help-section hidden" data-tab="chat">
                        <h3>Standard Chat</h3>
                        <p>Type a message and press <kbd>Enter</kbd> to send. Responses stream in real-time via SSE.</p>

                        <h4>Shared Memory / Context</h4>
                        <p>All messages are tracked in a shared memory window. Click the <strong>CTX</strong> button in the header to inspect:</p>
                        <ul>
                            <li>Each message's role, provider, model, token count</li>
                            <li>Context bar shows usage vs. the active model's context window limit</li>
                            <li>Bar turns <span style="color:var(--warning)">yellow</span> at 75% and <span style="color:var(--danger)">red</span> at 90%</li>
                        </ul>

                        <h4>Conversations</h4>
                        <ul>
                            <li><strong>+ New Chat</strong> &mdash; starts a fresh conversation</li>
                            <li><strong>Export</strong> &mdash; downloads the conversation as Markdown</li>
                            <li>History is stored in browser localStorage and listed in the right sidebar</li>
                            <li>Click any conversation in the sidebar to reload it</li>
                        </ul>

                        <h4>SMS Forward</h4>
                        <p>Send the last AI response as an SMS via email-to-SMS gateway. Enter your phone number, select your carrier, and click send.</p>

                        <h4>Markdown &amp; Code</h4>
                        <p>AI responses render full Markdown: headers, lists, bold/italic, code blocks with syntax highlighting (via highlight.js pattern), and inline code.</p>
                    </div>

                    <!-- Socratic -->
                    <div class="help-section hidden" data-tab="socratic">
                        <h3>Socratic Mode</h3>
                        <p>A multi-model roundtable debate. Multiple AI personas discuss your prompt, each powered by a different model.</p>

                        <h4>How it works</h4>
                        <ol>
                            <li>Click the <strong>Socratic</strong> button to activate</li>
                            <li>Configure 2&ndash;6 participants &mdash; each has a name, provider/model, and persona system prompt</li>
                            <li>Set the number of <strong>rounds</strong> (1&ndash;3)</li>
                            <li>Send your message &mdash; each participant responds in turn, seeing all prior responses</li>
                            <li>In round 2+, participants build on and challenge each other's ideas</li>
                        </ol>

                        <h4>Participant Cards</h4>
                        <ul>
                            <li>Edit the <strong>name</strong> by clicking on it</li>
                            <li>Change <strong>provider/model</strong> via the dropdowns</li>
                            <li>Write a <strong>persona prompt</strong> (e.g., "You are a skeptical scientist")</li>
                            <li>Click <strong>&times;</strong> to remove (minimum 2 participants)</li>
                            <li>Click <strong>+ Add Participant</strong> to add more (maximum 6)</li>
                            <li>Click <strong>Reset</strong> to restore defaults</li>
                        </ul>

                        <h4>Tips</h4>
                        <ul>
                            <li>Participants with invalid API keys are automatically skipped</li>
                            <li>Each response shows the persona's colored avatar and model badge</li>
                            <li>Round dividers separate the rounds visually</li>
                            <li>The synthesizer (last participant) wraps up the discussion</li>
                        </ul>
                    </div>

                    <!-- Code Mode -->
                    <div class="help-section hidden" data-tab="code">
                        <h3>Code Mode</h3>
                        <p>An agentic coding assistant with direct access to your local filesystem. Powered by Claude with tool use.</p>

                        <h4>How it works</h4>
                        <ol>
                            <li>Click the <strong>Code</strong> button to activate</li>
                            <li>Set the <strong>working directory</strong> to your project root</li>
                            <li>Choose a <strong>model</strong> (Opus 4.6 for complex tasks, Sonnet 4.5 for speed, Haiku 4.5 for simple queries)</li>
                            <li>Ask Claude to read, edit, or create files &mdash; it uses tools autonomously in a multi-turn loop</li>
                        </ol>

                        <h4>Available Tools</h4>
                        <table>
                            <tr><td><code>bash_exec</code></td><td>Run shell commands (with safety checks)</td></tr>
                            <tr><td><code>read_file</code></td><td>Read file contents with line numbers</td></tr>
                            <tr><td><code>write_file</code></td><td>Create or overwrite files</td></tr>
                            <tr><td><code>edit_file</code></td><td>Find-and-replace in files (exact string match)</td></tr>
                            <tr><td><code>list_files</code></td><td>List files matching a glob pattern</td></tr>
                            <tr><td><code>search_files</code></td><td>Regex search across files with line numbers</td></tr>
                        </table>

                        <h4>Security</h4>
                        <ul>
                            <li>Path traversal prevention &mdash; can't access files outside the working directory</li>
                            <li>Dangerous commands blocked &mdash; <code>rm -rf /</code>, <code>mkfs</code>, <code>format</code>, etc.</li>
                            <li>Output truncated at 30K characters to prevent context overflow</li>
                            <li>Max turns limit (default 25, max 50) prevents runaway loops</li>
                        </ul>

                        <h4>Tool Call UI</h4>
                        <ul>
                            <li>Each tool call shows as a collapsible block with <span style="color:#4ade80">green name</span></li>
                            <li>Status indicator: <span style="color:var(--warning)">RUNNING</span> &rarr; <span style="color:#22c55e">DONE</span> or <span style="color:var(--danger)">ERROR</span></li>
                            <li>Click the header to expand/collapse input and output</li>
                            <li>Bash output renders in terminal style (green on black)</li>
                            <li>Turn dividers show progress through the agentic loop</li>
                        </ul>
                    </div>

                    <!-- Parameters -->
                    <div class="help-section hidden" data-tab="params">
                        <h3>Parameters</h3>

                        <h4>Common Parameters</h4>
                        <table>
                            <tr><td><code>temperature</code></td><td>Randomness (0 = deterministic, 2 = very creative). Default: 1.0</td></tr>
                            <tr><td><code>top_p</code></td><td>Nucleus sampling &mdash; only consider tokens in the top P% probability mass. Default: 1.0</td></tr>
                            <tr><td><code>max_tokens</code></td><td>Maximum response length. Varies by model.</td></tr>
                            <tr><td><code>frequency_penalty</code></td><td>Penalizes repeated tokens. Range: -2 to 2 (OpenAI/Grok only)</td></tr>
                            <tr><td><code>presence_penalty</code></td><td>Penalizes tokens that have appeared at all. Range: -2 to 2 (OpenAI/Grok only)</td></tr>
                            <tr><td><code>top_k</code></td><td>Only sample from top K tokens (Anthropic/Google only)</td></tr>
                        </table>
                        <p><em>Note:</em> Anthropic's newer models (Sonnet 4.5+) reject <code>temperature</code> and <code>top_p</code> together. The UI handles this automatically in Socratic mode.</p>

                        <h4>Presets</h4>
                        <table>
                            <tr><td><strong>Creative</strong></td><td>temp=1.3, top_p=0.95, freq_penalty=0.3</td></tr>
                            <tr><td><strong>Precise</strong></td><td>temp=0.2, top_p=0.9, freq_penalty=0</td></tr>
                            <tr><td><strong>Balanced</strong></td><td>temp=0.7, top_p=0.95, freq_penalty=0.1</td></tr>
                            <tr><td><strong>Deterministic</strong></td><td>temp=0, top_p=1, all penalties=0</td></tr>
                        </table>

                        <h4>System Prompt</h4>
                        <p>Sets the AI's behavior for all messages in the conversation. Each provider sends this as a system message. Leave blank for the model's default behavior.</p>
                    </div>

                    <!-- Shortcuts -->
                    <div class="help-section hidden" data-tab="shortcuts">
                        <h3>Keyboard Shortcuts</h3>
                        <table>
                            <tr><td><kbd>Enter</kbd></td><td>Send message</td></tr>
                            <tr><td><kbd>Shift+Enter</kbd></td><td>New line in input</td></tr>
                            <tr><td><kbd>Esc</kbd></td><td>Stop generation / Close help</td></tr>
                        </table>

                        <h3>Architecture</h3>
                        <p>The server is a single <code>server.py</code> FastAPI application.</p>
                        <table>
                            <tr><td><code>server.py</code></td><td>API endpoints, streaming, provider routing</td></tr>
                            <tr><td><code>code_tools.py</code></td><td>Tool definitions and executors for Code Mode</td></tr>
                            <tr><td><code>static/index.html</code></td><td>Single-page HTML shell</td></tr>
                            <tr><td><code>static/app.js</code></td><td>All frontend logic (vanilla JS, no framework)</td></tr>
                            <tr><td><code>static/style.css</code></td><td>Dark theme styles</td></tr>
                            <tr><td><code>.env</code></td><td>API keys (not committed)</td></tr>
                        </table>

                        <h4>API Endpoints</h4>
                        <table>
                            <tr><td><code>GET /api/models</code></td><td>Available providers and models</td></tr>
                            <tr><td><code>POST /api/chat/stream</code></td><td>Standard chat (SSE)</td></tr>
                            <tr><td><code>POST /api/socratic/stream</code></td><td>Socratic roundtable (SSE)</td></tr>
                            <tr><td><code>POST /api/claude-code/stream</code></td><td>Code mode agentic loop (SSE)</td></tr>
                            <tr><td><code>GET /api/validate-keys</code></td><td>Check provider API keys</td></tr>
                            <tr><td><code>GET /api/socratic/defaults</code></td><td>Default Socratic participants</td></tr>
                            <tr><td><code>POST /api/sms</code></td><td>SMS forward via email gateway</td></tr>
                        </table>

                        <h4>Running</h4>
                        <pre>cd chat-ui
pip install fastapi uvicorn openai anthropic google-generativeai python-dotenv
python server.py
# Open http://localhost:8072</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Conversations -->
        <aside id="conversations-panel">
            <div class="sidebar-header">
                <h2>History</h2>
            </div>
            <div id="conversations-list"></div>
        </aside>
    </div>

    <script src="/app.js"></script>
</body>
</html>
